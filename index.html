<!doctype html>
<html lang="en">
<head>
  <link rel="icon" type="image/png" href="./icons/wahoo/wahoo-generic-wpt-icon.png">
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>POI Enricher</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <link rel="stylesheet" href="./style.css"/>
  <script>
    (function () {
      function showBoot(msg) {
        function reveal() {
          var box = document.getElementById('boot-error');
          if (!box) {
            if (!document.body) { setTimeout(reveal, 0); return; }
            box = document.createElement('div');
            box.id = 'boot-error';
            box.className = 'boot-error';
            document.body.prepend(box);
          }
          box.textContent = 'Startup error: ' + msg;
          box.style.display = 'block';
        }
        reveal();
      }
      window.__showBoot = showBoot;
      window.addEventListener('error', function (ev) {
        var t = ev.target;
        if (t && t !== window && (t.src || t.href)) {
          showBoot('Failed to load ' + (t.src || t.href));
          return;
        }
        var loc = ev.filename ? (' @ ' + ev.filename + ':' + ev.lineno + ':' + ev.colno) : '';
        showBoot((ev.message || 'Script error') + loc);
      }, true);
      window.addEventListener('unhandledrejection', function (ev) {
        showBoot((ev.reason && (ev.reason.stack || ev.reason.message)) || String(ev.reason || 'Promise rejected'));
      });
    })();
  </script>
</head>
<body>
  <div id="boot-error" class="boot-error" style="display:none"></div>
  <header class="topbar" role="banner">
    <div>
      <button id="btn-toggle-left" class="icon-btn" aria-pressed="true" title="Toggle left panel">
        <i class="ico burger" aria-hidden="true"></i>
      </button>
    </div>
    <div class="brand" aria-label="App title">
      <span class="title">POI Enricher</span>
    </div>
    <div>
      <button id="btn-add-poi" class="icon-btn" aria-pressed="false" title="Add POI">
        <i class="ico plus" aria-hidden="true"></i>
      </button>
      <button id="btn-toggle-right" class="icon-btn" aria-pressed="true" title="Toggle POIs panel">
        <i class="ico pin" aria-hidden="true"></i>
      </button>
    </div>
  </header>
  <main class="app" role="main" aria-label="Map and panels">
    <aside id="left-panel" class="panel-col open" aria-label="Left panel">
      <section class="panel" aria-labelledby="load-title">
        <h2 id="load-title">Load GPX</h2>
        <p class="hint">Pick a <strong>.gpx</strong> file. Drag &amp; drop anywhere also works.</p>
        <label class="hint block">
          <input id="opt-drop-wpts" type="checkbox"/>
          Ignore waypoints from file (don’t load or re-export them)
        </label>
        <br>
        <input id="file" type="file" accept=".gpx"/>
        <p id="status" class="status-in-box hint"></p>
      </section>
      <section class="panel" aria-labelledby="corridor-title">
        <h2 id="corridor-title">Search &amp; Export</h2>
        <div class="ranges-grid">
          <div class="rg-row">
            <label for="search-range-m">Search range</label>
            <div class="rg-input">
              <input id="search-range-m" type="number" min="50" step="50" value="500"/>
              <span class="unit">m</span>
            </div>
          </div>
          <div class="rg-row">
            <label for="poi-range-m">Export range</label>
            <div class="rg-input">
              <input id="poi-range-m" type="number" min="5" step="5" value="100"/>
              <span class="unit">m</span>
            </div>
          </div>

          <!-- NEW: ROI subsampling control -->
          <div class="rg-row">
            <label for="roi-maxpoints">Subsample route for ROI</label>
            <div class="rg-input">
              <input id="roi-maxpoints" type="number" min="500" step="500" value="4000"/>
              <span class="unit">pts</span>
            </div>
          </div>
        </div>
        <p class="hint">If the export range does not follow the gpx track, increase the value. Higher = more precise; lower = faster on huge files.</p>

        <label class="stacky">
          <span>Show line from POI to track</span>
          <input id="toggle-lines" type="checkbox" checked/>
        </label>
        <br>
        <div class="poi-controls">
          <a id="btn-download-gpx" class="btn" href="#" download="enriched.gpx">Download enriched GPX</a>
        </div>
      </section>
      <section class="panel" aria-labelledby="platform-title">
        <h2 id="platform-title">Device Template</h2>
        <div class="platform-row">
          <label for="platform-select" class="sr-only">Choose template</label>
          <select id="platform-select">
            <option value="wahoo" selected>Wahoo BOLT3/ROAM3/ACE</option>
            <option value="strava">Strava</option>
            <option value="rwgps">RWGPS</option>
            <option value="komoot">Komoot</option>
          </select>
          <span class="hint">Changes icon set + mapping. Clears fetched/custom POIs.</span>
        </div>
      </section>
      <section class="panel" aria-labelledby="about-title">
        <h2 id="about-title">About</h2>
        <div class="donate">
          <p>If this tool helps you, consider supporting it:</p>
          <a class="donate-btn" href="https://www.paypal.com/donate/?hosted_button_id=MJF3AHPSQGFLS" target="_blank" rel="noopener noreferrer">
            <img alt="Donate via PayPal" src="https://img.shields.io/badge/Donate-PayPal-blue.svg">
          </a>
        </div>
        <hr class="sep">
        <p>
          Load a GPX route and add nearby points of interest from OpenStreetMap: water taps, toilets, food, fuel, bike
          shops, campsites, viewpoints, and more. Alternatively, you can manually add POIs using the + button.
          <a href="https://support.wahoofitness.com/hc/en-us/articles/30255756674194-Custom-Waypoints-and-POIs-on-ELEMNT-ACE-BOLT-3-and-ROAM-3">Exported
            waypoints use Wahoo-compatible types so devices like the ACE, BOLT 3, and ROAM 3 display the right icons.</a>
          Tested on a ROAM 3: on-device maps currently render <code>water</code>, <code>food</code>, <code>summit</code>,
          <code>valley</code>, and <code>sprint</code> with dedicated icons; other documented types are shown as a <code>generic</code>
          marker. Not tested yet: Templates for Strava, RWPGS, and Komoot are also available - these limit the POI types panel to each
          platform's supported categories.
        </p>
      </section>
    </aside>
    <div class="map-wrap" aria-label="Map">
      <div id="map"></div>
    </div>
    <aside id="right-panel" class="panel-col open" aria-label="POI panel">
      <section class="panel" id="poi-panel" aria-labelledby="poi-title">
        <h2 id="poi-title" style="margin-bottom:6px">POI Selection</h2>
        <div class="sticky-header">
          <p class="status-in-box hint" aria-live="polite">Click a chip to unselect. You can also force-add any POI by clicking it on the map.</p>
          <div id="selected-chips" class="chips" aria-live="polite"></div>
          <hr class="sep">
          <div class="fetch-row">
            <button id="btn-fetch-selected" class="btn" type="button">Fetch selected</button>
            <button id="btn-fetch-all" class="btn btn-ghost" type="button">Fetch ALL</button>
          </div>
          <p id="poi-status" class="status-in-box hint" aria-live="polite"></p>
        </div>
        <div id="poi-groups" class="poi-groups" role="region" aria-label="POI categories"></div>
      </section>
    </aside>
  </main>
  <div id="add-poi-modal" class="modal-overlay" aria-hidden="true">
    <div class="modal" role="dialog" aria-labelledby="add-poi-heading" aria-modal="true">
      <div class="modal-head">
        <h3 id="add-poi-heading">Add custom POI</h3>
        <button id="add-poi-close" class="icon-btn small" title="Close"><i class="ico close"></i></button>
      </div>
      <div class="modal-body">
        <label class="field">
          <span>Name</span>
          <input id="add-poi-name" type="text" placeholder="e.g., I'm generic!"/>
        </label>
        <label class="field">
          <span>Description (optional)</span>
          <input id="add-poi-desc" type="text" placeholder="Extra info shown in GPX & device"/>
        </label>
        <div class="field">
          <span>POI type</span>
          <!-- NEW: filter box for types -->
          <input id="add-poi-filter" type="text" placeholder="Filter types (try: segment, trailhead, water…)"/>
          <div id="add-poi-types" class="type-list"></div>
        </div>
        <p class="hint">Click “Place on map”, then click the map where the POI should go.</p>
      </div>
      <div class="modal-foot">
        <button id="add-poi-cancel" class="btn btn-ghost" type="button">Cancel</button>
        <button id="add-poi-place" class="btn" type="button">Place on map</button>
      </div>
    </div>
  </div>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin="anonymous"></script>
  <script src="https://unpkg.com/@tmcw/togeojson" crossorigin="anonymous"></script>
  <script src="https://unpkg.com/@turf/turf@6.5.0/turf.min.js" crossorigin="anonymous"></script>
  <script type="module" src="./js/main.js"></script>
  <footer class="site-footer" role="contentinfo" aria-label="Credits">
    <div class="wrap">
      <p>Built with Leaflet.</p>
      <p style="text-align:center">All files are processed locally in your browser.</p>
      <p>No affiliation with any device maker.</p>
    </div>
  </footer>
</body>
</html>
